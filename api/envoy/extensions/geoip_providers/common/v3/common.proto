syntax = "proto3";

package envoy.extensions.geoip_providers.common.v3;

import "envoy/annotations/deprecation.proto";
import "udpa/annotations/status.proto";
import "validate/validate.proto";

option java_package = "io.envoyproxy.envoy.extensions.geoip_providers.common.v3";
option java_outer_classname = "CommonProto";
option java_multiple_files = true;
option go_package = "github.com/envoyproxy/go-control-plane/envoy/extensions/geoip_providers/common/v3;commonv3";
option (udpa.annotations.file_status).package_version_status = ACTIVE;

// [#protodoc-title: Common Geolocation Provider Configuration]
// Common geolocation provider :ref:`configuration overview <config_geoip_providers_common>`.
// Common configuration shared across geolocation providers.

message CommonGeoipProviderConfig {
  // The set of geolocation headers to add to the request. If any of the configured headers is present
  // in the incoming request, it will be overridden by the :ref:`HTTP GeoIP filter <config_http_filters_geoip>`.
  // Used by the HTTP GeoIP filter to populate request headers with geolocation data.
  // [#next-free-field: 13]
  message GeolocationHeadersToAdd {
    // If set, the header will be used to populate the country ISO code associated with the IP address.
    string country = 1
        [(validate.rules).string = {well_known_regex: HTTP_HEADER_NAME ignore_empty: true}];

    // If set, the header will be used to populate the city associated with the IP address.
    string city = 2
        [(validate.rules).string = {well_known_regex: HTTP_HEADER_NAME ignore_empty: true}];

    // If set, the header will be used to populate the region ISO code associated with the IP address.
    // The least specific subdivision will be selected as the region value.
    string region = 3
        [(validate.rules).string = {well_known_regex: HTTP_HEADER_NAME ignore_empty: true}];

    // If set, the header will be used to populate the ASN associated with the IP address.
    string asn = 4
        [(validate.rules).string = {well_known_regex: HTTP_HEADER_NAME ignore_empty: true}];

    // This field is deprecated; use ``anon`` instead.
    string is_anon = 5 [
      deprecated = true,
      (validate.rules).string = {well_known_regex: HTTP_HEADER_NAME ignore_empty: true},
      (envoy.annotations.deprecated_at_minor_version) = "3.0"
    ];

    // If set, the IP address will be checked if it belongs to any type of anonymization network (e.g., VPN, public proxy).
    // The header will be populated with the check result. Header value will be set to either ``true`` or ``false`` depending on the check result.
    string anon = 12
        [(validate.rules).string = {well_known_regex: HTTP_HEADER_NAME ignore_empty: true}];

    // If set, the IP address will be checked if it belongs to a VPN and the header will be populated with the check result.
    // Header value will be set to either ``true`` or ``false`` depending on the check result.
    string anon_vpn = 6
        [(validate.rules).string = {well_known_regex: HTTP_HEADER_NAME ignore_empty: true}];

    // If set, the IP address will be checked if it belongs to a hosting provider and the header will be populated with the check result.
    // Header value will be set to either ``true`` or ``false`` depending on the check result.
    string anon_hosting = 7
        [(validate.rules).string = {well_known_regex: HTTP_HEADER_NAME ignore_empty: true}];

    // If set, the IP address will be checked if it belongs to a TOR exit node and the header will be populated with the check result.
    // Header value will be set to either ``true`` or ``false`` depending on the check result.
    string anon_tor = 8
        [(validate.rules).string = {well_known_regex: HTTP_HEADER_NAME ignore_empty: true}];

    // If set, the IP address will be checked if it belongs to a public proxy and the header will be populated with the check result.
    // Header value will be set to either ``true`` or ``false`` depending on the check result.
    string anon_proxy = 9
        [(validate.rules).string = {well_known_regex: HTTP_HEADER_NAME ignore_empty: true}];

    // If set, the header will be used to populate the ISP associated with the IP address.
    string isp = 10
        [(validate.rules).string = {well_known_regex: HTTP_HEADER_NAME ignore_empty: true}];

    // If set, the IP address will be checked if it belongs to the ISP named iCloud Private Relay and the header will be populated with the check result.
    // Header value will be set to either ``true`` or ``false`` depending on the check result.
    string apple_private_relay = 11
        [(validate.rules).string = {well_known_regex: HTTP_HEADER_NAME ignore_empty: true}];
  }

  // The set of geolocation field keys for storing lookup results in filter state.
  // Used by the :ref:`Network GeoIP filter <config_network_filters_geoip>` to store geolocation
  // data in the connection's filter state. Unlike ``geo_headers_to_add``, these keys do not
  // need to follow HTTP header naming conventions.
  // [#next-free-field: 12]
  message GeolocationFilterStateKeys {
    // Key for the country ISO code associated with the IP address.
    string country = 1;

    // Key for the city associated with the IP address.
    string city = 2;

    // Key for the region ISO code associated with the IP address.
    string region = 3;

    // Key for the ASN associated with the IP address.
    string asn = 4;

    // Key for the anonymization network check result (``true`` or ``false``).
    string anon = 5;

    // Key for the VPN check result (``true`` or ``false``).
    string anon_vpn = 6;

    // Key for the hosting provider check result (``true`` or ``false``).
    string anon_hosting = 7;

    // Key for the TOR exit node check result (``true`` or ``false``).
    string anon_tor = 8;

    // Key for the public proxy check result (``true`` or ``false``).
    string anon_proxy = 9;

    // Key for the ISP associated with the IP address.
    string isp = 10;

    // Key for the iCloud Private Relay check result (``true`` or ``false``).
    string apple_private_relay = 11;
  }

  // Configuration for geolocation headers to add to HTTP requests.
  // At least one of ``geo_headers_to_add`` or ``geo_filter_state_keys`` must be set.
  GeolocationHeadersToAdd geo_headers_to_add = 1;

  // Configuration for geolocation filter state keys.
  // When set, the provider will use these keys for the lookup result, which can then be
  // stored in filter state by the Network GeoIP filter. If not set, the provider falls
  // back to using ``geo_headers_to_add`` keys.
  GeolocationFilterStateKeys geo_filter_state_keys = 2;
}
