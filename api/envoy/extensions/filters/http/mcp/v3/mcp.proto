syntax = "proto3";

package envoy.extensions.filters.http.mcp.v3;

import "google/protobuf/wrappers.proto";
import "xds/annotations/v3/status.proto";

import "udpa/annotations/status.proto";
import "validate/validate.proto";

option java_package = "io.envoyproxy.envoy.extensions.filters.http.mcp.v3";
option java_outer_classname = "McpProto";
option java_multiple_files = true;
option go_package = "github.com/envoyproxy/go-control-plane/envoy/extensions/filters/http/mcp/v3;mcpv3";
option (udpa.annotations.file_status).package_version_status = ACTIVE;
option (xds.annotations.v3.file_status).work_in_progress = true;

// [#protodoc-title: MCP]
// MCP filter :ref:`configuration overview <config_http_filters_mcp>`.
// [#extension: envoy.filters.http.mcp]

// This filter will inspect and get attributes from MCP traffic.
message Mcp {
  // Traffic handling mode for non-MCP traffic.
  enum TrafficMode {
    // Proxies the HTTP request and response without MCP spec check.
    // This is the default mode.
    PASS_THROUGH = 0;

    // Reject requests that are not following MCP spec.
    // Valid MCP requests are:
    // - POST requests with JSON-RPC 2.0 messages
    // - GET requests for SSE streams (with Accept: text/event-stream)
    REJECT_NO_MCP = 1;
  }

  // Configures how the filter handles non-MCP traffic.
  TrafficMode traffic_mode = 1 [(validate.rules).enum = {defined_only: true}];

  // When set to true, the filter will clear the route cache after setting dynamic metadata.
  // This allows the route to be re-selected based on the MCP metadata (e.g., method, params).
  // Defaults to false.
  bool clear_route_cache = 2;

  google.protobuf.UInt32Value max_request_body_size = 3 [(validate.rules).uint32 = {lte: 10485760}];

    // Parser configuration
  ParserConfig parser_config = 4;
}

// Parser configuration (simplified from json_to_metadata style)
message ParserConfig {
  // A rule to extract a value from JSON
  message Rule {
    // Path to the value in JSON using dot notation for nested fields
    // Examples:
    //   "method" - top level field
    //   "params.tool_name" - nested field
    //   "params.config.timeout" - deeply nested field
    string path = 1 [(validate.rules).string = {min_len: 1}];
    
    // The key name to use in the metadata
    // If not set, defaults to the original path
    string key = 2;

    // Allow the path to be missed.
    bool allow_missing = 3;
  }

  // Rules to apply
  repeated Rule rules = 1;
}

// McpOverride for MCP filter
message McpOverride {
  // Optional per-route traffic mode override
  Mcp.TrafficMode traffic_mode = 1 [(validate.rules).enum = {defined_only: true}];
}
