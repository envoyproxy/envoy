syntax = "proto3";

package envoy.extensions.filters.http.mcp.v3;

import "google/protobuf/wrappers.proto";

import "xds/annotations/v3/status.proto";

import "udpa/annotations/status.proto";
import "validate/validate.proto";

option java_package = "io.envoyproxy.envoy.extensions.filters.http.mcp.v3";
option java_outer_classname = "McpProto";
option java_multiple_files = true;
option go_package = "github.com/envoyproxy/go-control-plane/envoy/extensions/filters/http/mcp/v3;mcpv3";
option (udpa.annotations.file_status).package_version_status = ACTIVE;
option (xds.annotations.v3.file_status).work_in_progress = true;

// [#protodoc-title: MCP]
// MCP filter :ref:`configuration overview <config_http_filters_mcp>`.
// [#extension: envoy.filters.http.mcp]

// This filter will inspect and get attributes from MCP traffic.
message Mcp {
  // Traffic handling mode for non-MCP traffic.
  enum TrafficMode {
    // Proxies the HTTP request and response without MCP spec check.
    // This is the default mode.
    PASS_THROUGH = 0;

    // Reject requests that are not following MCP spec.
    // Valid MCP requests are:
    // - POST requests with JSON-RPC 2.0 messages
    // - GET requests for SSE streams (with Accept: text/event-stream)
    REJECT_NO_MCP = 1;
  }

  // Configures how the filter handles non-MCP traffic.
  TrafficMode traffic_mode = 1 [(validate.rules).enum = {defined_only: true}];

  // When set to true, the filter will clear the route cache after setting dynamic metadata.
  // This allows the route to be re-selected based on the MCP metadata (e.g., method, params).
  // Defaults to false.
  bool clear_route_cache = 2;

  // Maximum size of the request body to buffer for JSON-RPC validation.
  // If the request body exceeds this size, the request is rejected with ``413 Payload Too Large``.
  // This limit applies to both ``REJECT_NO_MCP`` and ``PASS_THROUGH`` modes to prevent unbounded buffering.
  //
  // It defaults to 8KB (8192 bytes) and the maximum allowed value is 10MB (10485760 bytes).
  //
  // Setting it to 0 would disable the limit. It is not recommended to do so in production.
  google.protobuf.UInt32Value max_request_body_size = 3 [(validate.rules).uint32 = {lte: 10485760}];

  // Parser configuration, this provide the attribute extraction override.
  ParserConfig parser_config = 4;
}

// Parser configuration with method-specific rules.
// This configuration allows overriding the default attribute extraction behavior for specific MCP methods.
message ParserConfig {
  // A single attribute extraction rule.
  message AttributeExtractionRule {
    // JSON path to extract (e.g., "params.name", "params.uri").
    // The path is a dot-separated string representing the location of the field in the JSON payload.
    // For example, "params.name" extracts the "name" field from the "params" object.
    string path = 1 [(validate.rules).string = {min_len: 1}];
  }

  // Configuration for a specific MCP method.
  message MethodConfig {
    // Method name (e.g., "tools/call", "resources/read", "initialize").
    // This matches the "method" field in the JSON-RPC request.
    string method = 1 [(validate.rules).string = {min_len: 1}];

    // The group/category name to assign to this method (e.g., "tool", "lifecycle").
    // This will be emitted to dynamic metadata under the key specified by group_metadata_key.
    // If empty, the built-in group classification is used.
    string group = 2;

    // Attributes to extract for this method.
    // If empty, only default attributes (jsonrpc, method) are extracted.
    repeated AttributeExtractionRule extraction_rules = 3;
  }

  // List of rules for classification and extraction.
  // Rules are evaluated in order; the first match wins.
  // If no rule matches, extraction defaults are used and group falls back to built-in classification.
  // Built-in groups: lifecycle, tool, resource, prompt, notification, logging, sampling, completion, unknown.
  repeated MethodConfig methods = 1;

  // The dynamic metadata key where the group name will be stored.
  // If empty, group classification is disabled.
  string group_metadata_key = 2;
}

// Per-route override configuration for MCP filter
message McpOverride {
  // Optional per-route traffic mode override
  Mcp.TrafficMode traffic_mode = 1 [(validate.rules).enum = {defined_only: true}];

  // Optional per-route max request body size override.
  // When set, this overrides the global max_request_body_size for this route.
  // It defaults to 8KB (8192 bytes) and the maximum allowed value is 10MB (10485760 bytes).
  google.protobuf.UInt32Value max_request_body_size = 2 [(validate.rules).uint32 = {lte: 10485760}];
}
