## Any new configs - ie that are not defined in Envoy's bazelrc ...
#    **should be prefixed with mobile-**

# Envoy Mobile Bazel build/test options.
try-import ../.bazelrc

#############################################################################
# global
#############################################################################

# Common flags for all builds
build --platform_mappings=bazel/platform_mappings
build --define=hot_restart=disabled
build --define=tcmalloc=disabled
build --define=admin_html=disabled
build --define=static_extension_registration=disabled
build --define=admin_functionality=disabled
build --define envoy_mobile_listener=disabled
build --define=library_autolink=disabled
build --define=envoy_enable_http_datagrams=disabled
build --experimental_inmemory_dotd_files
build --experimental_inmemory_jdeps_files
build --features=debug_prefix_map_pwd_is_dot
build --features=swift.cacheable_swiftmodules
build --features=swift.debug_prefix_map
build --host_force_python=PY3
build --macos_minimum_os=14.5
build --ios_simulator_version=18.1
build --verbose_failures
build --workspace_status_command=../bazel/get_workspace_status
build --use_top_level_targets_for_symlinks
build --experimental_repository_downloader_retries=2
build --define=envoy_mobile_xds=disabled
build --define=google_grpc=disabled
build --define=nghttp2=disabled
build --define=envoy_yaml=disabled
build --define=envoy_full_protos=disabled
build --define envoy_exceptions=disabled
build: --copt=-fno-exceptions

# We don't have a ton of Swift in Envoy Mobile, so always build with WMO
# This also helps work around a bug in rules_swift: https://github.com/bazelbuild/rules_swift/issues/949
build --swiftcopt=-wmo
# https://github.com/bazelbuild/rules_jvm_external/issues/445
build --repo_env=JAVA_HOME=../bazel_tools/jdk
build --define disable_known_issue_asserts=true
# Unset per_object_debug_info. Causes failures on Android Linux release builds.
build --features=-per_object_debug_info
# Suppress deprecated declaration warnings due to extensive transitive noise from protobuf.
build --copt -Wno-deprecated-declarations
build --define=signal_trace=disabled

# Override PGV validation with NOP functions for binary size savings.
build --@com_envoyproxy_protoc_gen_validate//bazel:template-flavor=nop

# Instrument Envoy Mobile's C++ code for coverage
coverage --instrumentation_filter="//library/common[/:]"

#############################################################################
# os
#############################################################################

# Common Engflow flags
build:linux --disk_cache=
build:linux --incompatible_strict_action_env=true
build:linux --action_env=BAZEL_DO_NOT_DETECT_CPP_TOOLCHAIN=1

# Default flags for builds targeting iOS
# Manual stamping is necessary in order to get versioning information in the iOS
# static framework.
# More information on stamping can be found here:
# https://github.com/envoyproxy/envoy/tree/master/bazel#enabling-optional-features
build:ios --define=manual_stamp=manual_stamp
build:ios --test_timeout=390,750,1500,5700
build:ios --define=envoy_full_protos=enabled

# Default flags for builds targeting Android
build:android --define=logger=android
build:android --java_language_version=8
build:android --tool_java_language_version=8

# Default flags for Android
build:mobile-android --android_crosstool_top=@androidndk//:toolchain
build:mobile-android --noincompatible_enable_android_toolchain_resolution
build:mobile-android --java_language_version=8
build:mobile-android --tool_java_language_version=8
test:mobile-android --build_tests_only
test:mobile-android --define=static_extension_registration=disabled


#############################################################################
# toolchain: clang
#############################################################################
# Clang toolchain options
build:mobile-clang --crosstool_top=//third_party/rbe_configs/cc:toolchain
build:mobile-clang --extra_execution_platforms=//third_party/rbe_configs/config:platform
build:mobile-clang --extra_toolchains=//third_party/rbe_configs/config:cc-toolchain
build:mobile-clang --host_platform=//third_party/rbe_configs/config:platform
build:mobile-clang --platforms=//third_party/rbe_configs/config:platform
build:mobile-clang --config=libc++
build:mobile-clang --action_env=CC=/opt/llvm/bin/clang
build:mobile-clang --action_env=CXX=/opt/llvm/bin/clang++

build:mobile-remote-clang --config=mobile-clang
build:mobile-remote-clang --config=mobile-remote


#############################################################################
# platform: remote
#############################################################################
build:mobile-remote-ci --config=mobile-remote-clang
build:mobile-remote-ci --config=remote-ci
build:mobile-remote-ci --test_env=ENVOY_IP_TEST_VERSIONS=v4only

build:mobile-remote --config=rbe-engflow
build:mobile-remote --jobs=40
build:mobile-remote --verbose_failures
build:mobile-remote --spawn_strategy=remote,sandboxed,local
build:mobile-remote --experimental_ui_max_stdouterr_bytes=10485760

# order matters here to ensure downloads
build:mobile-remote-release --config=mobile-remote-clang
build:mobile-remote-release --config=mobile-release-common
build:mobile-remote-release --remote_download_toplevel
build:mobile-remote-release --config=ci
build:mobile-remote-release --config=remote

build:mobile-release-android --android_platforms=//:android_x86_64
build:mobile-release-android --linkopt=-fuse-ld=lld
build:mobile-release-android --config=mobile-android
build:mobile-release-android --fat_apk_cpu=x86_64

build:mobile-release-android-publish --config=mobile-remote-release
build:mobile-release-android-publish --config=mobile-release-android
build:mobile-release-android-publish --android_platforms=//:android_x86_32,//:android_x86_64,//:android_armv7,//:android_arm64
build:mobile-release-android-publish --linkopt=-fuse-ld=lld
build:mobile-release-android-publish --fat_apk_cpu=x86,x86_64,armeabi-v7a,arm64-v8a


#############################################################################
# toolchains: sanitizers/linux
#############################################################################
# ASAN
build:mobile-asan --config=asan
build:mobile-asan --config=clang
build:mobile-asan --config=mobile-remote-clang
build:mobile-asan --build_tests_only
test:mobile-asan --test_env=ENVOY_IP_TEST_VERSIONS=v4only

# MSAN
build:mobile-msan --config=msan --config=clang

# TSAN
build:mobile-tsan --config=clang
build:mobile-tsan --config=tsan
build:mobile-tsan --config=mobile-remote-clang
build:mobile-tsan --build_tests_only
test:mobile-tsan --test_env=ENVOY_IP_TEST_VERSIONS=v4only


#############################################################################
# tests: linux
#############################################################################

# CC
test:mobile-cc --action_env=LD_LIBRARY_PATH

# CC with xDS
build:mobile-cc-xds-enabled --config=mobile-cc
test:mobile-cc-xds-enabled --define=envoy_mobile_xds=enabled

# Coverage
build:mobile-coverage --build_tests_only
build:mobile-coverage --@envoy//tools/coverage:config=@envoy_mobile//test:coverage_config
build:mobile-coverage --config=mobile-clang
build:mobile-coverage --legacy_important_outputs=false
build:mobile-coverage --test_env=ENVOY_IP_TEST_VERSIONS=v4only


#############################################################################
# macos: These options are macOS-only
#############################################################################

build:rules_xcodeproj --config=ios
build:rules_xcodeproj --define=apple.experimental.tree_artifact_outputs=0
# Disable global index store to work around https://github.com/buildbuddy-io/rules_xcodeproj/issues/1878
build:rules_xcodeproj --features=-swift.use_global_index_store

build:mobile-macos --config=mobile-remote
build:mobile-macos --host_platform=//ci/platform:macos
build:mobile-macos --platforms=//ci/platform:macos
build:mobile-macos --extra_execution_platforms=//ci/platform:macos
build:mobile-macos --xcode_version_config=//ci:xcode_config
build:mobile-macos --remote_download_toplevel
build:mobile-macos --config=ci
build:mobile-macos --config=remote
build:mobile-macos --define=envoy_full_protos=disabled

build:mobile-macos-ios --config=mobile-macos
build:mobile-macos-ios --config=ios
build:mobile-macos-ios --strategy=ProcessAndSign=sandboxed,local

build:mobile-macos-ios-swift --config=mobile-macos-ios
test:mobile-macos-ios-swift --build_tests_only

build:mobile-macos-ios-obj-c --config=mobile-macos-ios
test:mobile-macos-ios-obj-c --build_tests_only


#############################################################################
# release
#############################################################################

# Exclude debug info from the release binary since it makes it too large to fit
# into a zip file. This shouldn't affect crash reports.
build:mobile-release-common --define=no_debug_info=1
# Compile releases optimizing for size (eg -Os, etc).
build:mobile-release-common --config=sizeopt
# Set default symbols visibility to hidden to reduce .dynstr and the symbol table size
build:mobile-release-common --copt=-fvisibility=hidden
# Enable automatic extension factory registration for release builds
build:mobile-release-common --define=static_extension_registration=enabled

# Flags for release builds targeting iOS
build:mobile-release-ios --config=ios
build:mobile-release-ios --config=mobile-release-common
build:mobile-release-ios --compilation_mode=opt

# Flags for release builds targeting Android or the JVM
# Release does not use the option --define=logger=android
build:mobile-release-android --config=mobile-release-common
build:mobile-release-android --compilation_mode=opt
build:mobile-release-android --config=mobile-android


#############################################################################
# toolchains: dbg
#############################################################################

build:mobile-dbg-common --compilation_mode=dbg
# Enable source map for debugging in IDEs
build:mobile-dbg-common --copt="-fdebug-compilation-dir" --copt="/proc/self/cwd"

# Default flags for Android debug builds
build:mobile-dbg-android --config=mobile-dbg-common
build:mobile-dbg-android --config=android

# Default flags for iOS debug builds
build:mobile-dbg-ios --config=mobile-dbg-common
build:mobile-dbg-ios --config=ios
