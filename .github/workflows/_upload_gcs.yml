name: Upload to GCS

permissions:
  contents: read

on:
  workflow_call:
    secrets:
      gcp-key:
        required: true
    inputs:
      artifacts:
        description: JSON array of artifacts to upload to GCS
        type: string
        required: true


jobs:
  upload:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        artifact: ${{ fromJSON(inputs.artifacts) }}
    steps:
    - uses: actions/download-artifact@v4.1.3
      with:
        name: ${{ matrix.artifact }}
        path: ${{ matrix.artifact }}
    - uses: envoyproxy/toolshed/actions/jq@8d5d8d4b9eeb5e4e76b92341b0b1b1f6438af231  # v0.4.5
      id: metadata
      with:
        input: ${{ matrix.artifact }}/gcs-metadata.json
        input-format: json-path
    - run: |
        rm -rf ${{ matrix.artifact }}/gcs-metadata.json
    - uses: envoyproxy/toolshed/actions/gcp/setup@8d5d8d4b9eeb5e4e76b92341b0b1b1f6438af231  # v0.4.5
      with:
        key: ${{ secrets.gcp-key }}
    - uses: envoyproxy/toolshed/actions/gcs/artefact/sync@8d5d8d4b9eeb5e4e76b92341b0b1b1f6438af231  # v0.4.5
      with:
        bucket: ${{ fromJSON(steps.metadata.outputs.value).bucket }}
        path: ${{ matrix.artifact }}
        path-upload: ${{ matrix.artifact }}
        sha: ${{ fromJSON(steps.metadata.outputs.value).sha }}
        redirect: ${{ fromJSON(steps.metadata.outputs.value).redirect }}
