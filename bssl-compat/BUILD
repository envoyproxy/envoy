load("@rules_cc//cc:defs.bzl", "cc_library")
load("//:bazel/rules.bzl", "mapping_func_filegroup", "patched_bssl_filegroup")

licenses(["notice"])  # Apache 2

# This genrule runs the prefixer tool to process OpenSSL headers.
# It generates:
# - source/ossl.c: Forwarding functions that call OpenSSL via dlopen/dlsym
# - include/ossl.h: Header declaring the ossl struct with function pointers
# - include/ossl/openssl/*.h: Prefixed OpenSSL headers with ossl_ prefix
genrule(
    name = "prefixed_ossl_source",
    srcs = [
        "@openssl//:include",
        "@llvm_toolchain_llvm//:include",
    ],
    outs = [
        "source/ossl.c",
        "include/ossl.h",
        "include/ossl/openssl/aes.h",
        "include/ossl/openssl/asn1.h",
        "include/ossl/openssl/asn1err.h",
        "include/ossl/openssl/asn1t.h",
        "include/ossl/openssl/async.h",
        "include/ossl/openssl/asyncerr.h",
        "include/ossl/openssl/bio.h",
        "include/ossl/openssl/bioerr.h",
        "include/ossl/openssl/blowfish.h",
        "include/ossl/openssl/bn.h",
        "include/ossl/openssl/bnerr.h",
        "include/ossl/openssl/buffer.h",
        "include/ossl/openssl/buffererr.h",
        "include/ossl/openssl/byteorder.h",
        "include/ossl/openssl/camellia.h",
        "include/ossl/openssl/cast.h",
        "include/ossl/openssl/cmac.h",
        "include/ossl/openssl/cmp.h",
        "include/ossl/openssl/cmp_util.h",
        "include/ossl/openssl/cmperr.h",
        "include/ossl/openssl/cms.h",
        "include/ossl/openssl/cmserr.h",
        "include/ossl/openssl/comp.h",
        "include/ossl/openssl/comperr.h",
        "include/ossl/openssl/conf.h",
        "include/ossl/openssl/conf_api.h",
        "include/ossl/openssl/conferr.h",
        "include/ossl/openssl/configuration.h",
        "include/ossl/openssl/conftypes.h",
        "include/ossl/openssl/core.h",
        "include/ossl/openssl/core_dispatch.h",
        "include/ossl/openssl/core_names.h",
        "include/ossl/openssl/core_object.h",
        "include/ossl/openssl/crmf.h",
        "include/ossl/openssl/crmferr.h",
        "include/ossl/openssl/crypto.h",
        "include/ossl/openssl/cryptoerr.h",
        "include/ossl/openssl/cryptoerr_legacy.h",
        "include/ossl/openssl/ct.h",
        "include/ossl/openssl/cterr.h",
        "include/ossl/openssl/decoder.h",
        "include/ossl/openssl/decodererr.h",
        "include/ossl/openssl/des.h",
        "include/ossl/openssl/dh.h",
        "include/ossl/openssl/dherr.h",
        "include/ossl/openssl/dsa.h",
        "include/ossl/openssl/dsaerr.h",
        "include/ossl/openssl/dtls1.h",
        "include/ossl/openssl/e_os2.h",
        "include/ossl/openssl/e_ostime.h",
        "include/ossl/openssl/ebcdic.h",
        "include/ossl/openssl/ec.h",
        "include/ossl/openssl/ecdh.h",
        "include/ossl/openssl/ecdsa.h",
        "include/ossl/openssl/ecerr.h",
        "include/ossl/openssl/encoder.h",
        "include/ossl/openssl/encodererr.h",
        "include/ossl/openssl/engine.h",
        "include/ossl/openssl/engineerr.h",
        "include/ossl/openssl/err.h",
        "include/ossl/openssl/ess.h",
        "include/ossl/openssl/esserr.h",
        "include/ossl/openssl/evp.h",
        "include/ossl/openssl/evperr.h",
        "include/ossl/openssl/fips_names.h",
        "include/ossl/openssl/fipskey.h",
        "include/ossl/openssl/hmac.h",
        "include/ossl/openssl/hpke.h",
        "include/ossl/openssl/http.h",
        "include/ossl/openssl/httperr.h",
        "include/ossl/openssl/idea.h",
        "include/ossl/openssl/indicator.h",
        "include/ossl/openssl/kdf.h",
        "include/ossl/openssl/kdferr.h",
        "include/ossl/openssl/lhash.h",
        "include/ossl/openssl/macros.h",
        "include/ossl/openssl/md2.h",
        "include/ossl/openssl/md4.h",
        "include/ossl/openssl/md5.h",
        "include/ossl/openssl/mdc2.h",
        "include/ossl/openssl/modes.h",
        "include/ossl/openssl/obj_mac.h",
        "include/ossl/openssl/objects.h",
        "include/ossl/openssl/objectserr.h",
        "include/ossl/openssl/ocsp.h",
        "include/ossl/openssl/ocsperr.h",
        "include/ossl/openssl/opensslconf.h",
        "include/ossl/openssl/opensslv.h",
        "include/ossl/openssl/ossl_typ.h",
        "include/ossl/openssl/param_build.h",
        "include/ossl/openssl/params.h",
        "include/ossl/openssl/pem.h",
        "include/ossl/openssl/pem2.h",
        "include/ossl/openssl/pemerr.h",
        "include/ossl/openssl/pkcs12.h",
        "include/ossl/openssl/pkcs12err.h",
        "include/ossl/openssl/pkcs7.h",
        "include/ossl/openssl/pkcs7err.h",
        "include/ossl/openssl/prov_ssl.h",
        "include/ossl/openssl/proverr.h",
        "include/ossl/openssl/provider.h",
        "include/ossl/openssl/quic.h",
        "include/ossl/openssl/rand.h",
        "include/ossl/openssl/randerr.h",
        "include/ossl/openssl/rc2.h",
        "include/ossl/openssl/rc4.h",
        "include/ossl/openssl/rc5.h",
        "include/ossl/openssl/ripemd.h",
        "include/ossl/openssl/rsa.h",
        "include/ossl/openssl/rsaerr.h",
        "include/ossl/openssl/safestack.h",
        "include/ossl/openssl/seed.h",
        "include/ossl/openssl/self_test.h",
        "include/ossl/openssl/sha.h",
        "include/ossl/openssl/srp.h",
        "include/ossl/openssl/srtp.h",
        "include/ossl/openssl/ssl.h",
        "include/ossl/openssl/ssl2.h",
        "include/ossl/openssl/ssl3.h",
        "include/ossl/openssl/sslerr.h",
        "include/ossl/openssl/sslerr_legacy.h",
        "include/ossl/openssl/stack.h",
        "include/ossl/openssl/store.h",
        "include/ossl/openssl/storeerr.h",
        "include/ossl/openssl/symhacks.h",
        "include/ossl/openssl/thread.h",
        "include/ossl/openssl/tls1.h",
        "include/ossl/openssl/trace.h",
        "include/ossl/openssl/ts.h",
        "include/ossl/openssl/tserr.h",
        "include/ossl/openssl/txt_db.h",
        "include/ossl/openssl/types.h",
        "include/ossl/openssl/ui.h",
        "include/ossl/openssl/uierr.h",
        "include/ossl/openssl/whrlpool.h",
        "include/ossl/openssl/x509.h",
        "include/ossl/openssl/x509_acert.h",
        "include/ossl/openssl/x509_vfy.h",
        "include/ossl/openssl/x509err.h",
        "include/ossl/openssl/x509v3.h",
        "include/ossl/openssl/x509v3err.h",
    ],
    cmd = """
        # The @llvm//:clang-headers target provides the include directory for
        # the Clang compiler headers that are required to satisfy #includes in
        # the OpenSSL headers (limits.h, stddef.h etc)
        CLANG_INCLUDE_DIR=""
        # Find the clang builtin include directory (contains stddef.h, stdarg.h, etc.)
        # We need the path under lib/clang/*/include/, not the libc++ stddef.h
        for f in $(locations @llvm_toolchain_llvm//:include); do
            if [[ "$$f" == */clang/*/include/stddef.h ]]; then
                CLANG_INCLUDE_DIR="$$(cd "$$(dirname "$$f")" && pwd)"
                break
            fi
        done

        # Set up LD_LIBRARY_PATH for libclang-cpp.so
        LLVM_LIB_DIR=$$(dirname $(location @llvm_toolchain_llvm//:lib/libclang-cpp.so.18.1))
        export LD_LIBRARY_PATH="$$LLVM_LIB_DIR$${LD_LIBRARY_PATH:+:$$LD_LIBRARY_PATH}"

        # Run the prefixer with absolute source path and relative output path
        $(location //prefixer:prefixer) \
            --src-path "$(location @openssl//:include)" \
            --src-incl "openssl/*.h" \
            --src-skip "openssl/asn1_mac.h" \
            --src-skip "openssl/opensslconf-*.h" \
            --include "$$CLANG_INCLUDE_DIR" \
            --output $(RULEDIR) \
            --prefix ossl 2>&1
    """,
    tools = [
        "//prefixer",
        "@llvm_toolchain_llvm//:lib/libclang-cpp.so.18.1",
    ],
    visibility = ["//visibility:private"],
)

# Create rules for processing all BoringSSL headers. This creates one genrule
# per header file, which copies that header from BoringSSL, applying any
# necessary patches. This also creates a filegroup called :patched_bssl_headers
# which contains all the resulting copied & patched headers.
patched_bssl_filegroup(
    name = "patched_bssl_headers",
    srcs = [
        "include/openssl/aead.h",
        "include/openssl/aes.h",
        "include/openssl/arm_arch.h",
        "include/openssl/asm_base.h",
        "include/openssl/asn1.h",
        "include/openssl/asn1_mac.h",
        "include/openssl/asn1t.h",
        "include/openssl/base.h",
        "include/openssl/base64.h",
        "include/openssl/bio.h",
        "include/openssl/blake2.h",
        "include/openssl/blowfish.h",
        "include/openssl/bn.h",
        "include/openssl/buf.h",
        "include/openssl/buffer.h",
        "include/openssl/bytestring.h",
        "include/openssl/cast.h",
        "include/openssl/chacha.h",
        "include/openssl/cipher.h",
        "include/openssl/cmac.h",
        "include/openssl/conf.h",
        "include/openssl/cpu.h",
        "include/openssl/crypto.h",
        "include/openssl/curve25519.h",
        "include/openssl/des.h",
        "include/openssl/dh.h",
        "include/openssl/digest.h",
        "include/openssl/dsa.h",
        "include/openssl/dtls1.h",
        "include/openssl/e_os2.h",
        "include/openssl/ec.h",
        "include/openssl/ec_key.h",
        "include/openssl/ecdh.h",
        "include/openssl/ecdsa.h",
        "include/openssl/engine.h",
        "include/openssl/err.h",
        "include/openssl/evp.h",
        "include/openssl/evp_errors.h",
        "include/openssl/ex_data.h",
        "include/openssl/hkdf.h",
        "include/openssl/hmac.h",
        "include/openssl/hpke.h",
        "include/openssl/hrss.h",
        "include/openssl/is_boringssl.h",
        "include/openssl/kdf.h",
        "include/openssl/lhash.h",
        "include/openssl/md4.h",
        "include/openssl/md5.h",
        "include/openssl/mem.h",
        "include/openssl/mlkem.h",
        "include/openssl/nid.h",
        "include/openssl/obj.h",
        "include/openssl/obj_mac.h",
        "include/openssl/objects.h",
        "include/openssl/opensslconf.h",
        "include/openssl/opensslv.h",
        "include/openssl/ossl_typ.h",
        "include/openssl/pem.h",
        "include/openssl/pkcs12.h",
        "include/openssl/pkcs7.h",
        "include/openssl/pkcs8.h",
        "include/openssl/pki/certificate.h",
        "include/openssl/pki/signature_verify_cache.h",
        "include/openssl/pki/verify.h",
        "include/openssl/pki/verify_error.h",
        "include/openssl/poly1305.h",
        "include/openssl/pool.h",
        "include/openssl/posix_time.h",
        "include/openssl/rand.h",
        "include/openssl/rc4.h",
        "include/openssl/ripemd.h",
        "include/openssl/rsa.h",
        "include/openssl/safestack.h",
        "include/openssl/service_indicator.h",
        "include/openssl/sha.h",
        "include/openssl/sha2.h",
        "include/openssl/siphash.h",
        "include/openssl/slhdsa.h",
        "include/openssl/span.h",
        "include/openssl/srtp.h",
        "include/openssl/ssl.h",
        "include/openssl/ssl3.h",
        "include/openssl/stack.h",
        "include/openssl/target.h",
        "include/openssl/thread.h",
        "include/openssl/tls1.h",
        "include/openssl/trust_token.h",
        "include/openssl/type_check.h",
        "include/openssl/x509.h",
        "include/openssl/x509_vfy.h",
        "include/openssl/x509v3.h",
        "include/openssl/x509v3_errors.h",
    ],
)

# Create rules for processing all BoringSSL sources that we need. This creates
# one genrule per source file, which copies that source from BoringSSL, applying
# any necessary patches. This also creates a filegroup called
# :patched_bssl_sources which contains all the copied & patched sources.
patched_bssl_filegroup(
    name = "patched_bssl_sources",
    srcs = [
        "crypto/bytestring/cbb.cc",
        "crypto/bytestring/cbs.cc",
        "crypto/internal.h",
        "crypto/mem.cc",
        "ssl/ssl_x509.cc",
    ],
)

# List of mapping functions. For each listed mapping function, either a
# handwritten source file exists in source/{function}.c/.cc, or a genrule is
# created that generates a source file which implements simple direct call
# forwarding. This also creates a filegroup called :mapping_function_sources
# which contains all the source files.
mapping_func_filegroup(
    name = "mapping_function_sources",
    funcs = [
        "ASN1_ENUMERATED_to_BN",
        "ASN1_BMPSTRING_new",
        "ASN1_UNIVERSALSTRING_new",
        "ASN1_IA5STRING_free",
        "ASN1_IA5STRING_new",
        "ASN1_INTEGER_free",
        "ASN1_INTEGER_new",
        "ASN1_INTEGER_to_BN",
        "ASN1_INTEGER_set_uint64",
        "ASN1_OBJECT_free",
        "ASN1_STRING_data",
        "ASN1_STRING_free",
        "ASN1_STRING_get0_data",
        "ASN1_STRING_length",
        "ASN1_STRING_set",
        "ASN1_STRING_to_UTF8",
        "ASN1_TIME_adj",
        "ASN1_TIME_diff",
        "ASN1_TIME_free",
        "ASN1_TIME_new",
        "ASN1_TIME_set",
        "ASN1_TYPE_new",
        "ASN1_TYPE_set",
        "BASIC_CONSTRAINTS_free",
        "BASIC_CONSTRAINTS_new",
        "BIO_clear_flags",
        "BIO_set_flags",
        "BIO_test_flags",
        "BIO_clear_retry_flags",
        "BIO_ctrl_get_read_request",
        "BIO_ctrl_get_write_guarantee",
        "BIO_ctrl",
        "BIO_eof",
        "BIO_free_all",
        "BIO_free",
        "BIO_get_data",
        "BIO_get_init",
        "BIO_get_mem_data",
        "BIO_get_mem_ptr",
        "BIO_get_shutdown",
        "BIO_gets",
        "BIO_mem_contents",
        "BIO_meth_new",
        "BIO_meth_set_create",
        "BIO_meth_set_ctrl",
        "BIO_meth_set_destroy",
        "BIO_meth_set_read",
        "BIO_meth_set_write",
        "BIO_new_bio_pair",
        "BIO_new_connect",
        "BIO_new_fd",
        "BIO_new_file",
        "BIO_new_fp",
        "BIO_new_mem_buf",
        "BIO_new_socket",
        "BIO_new",
        "BIO_pending",
        "BIO_printf",
        "BIO_puts",
        "BIO_read_asn1",
        "BIO_read_filename",
        "BIO_read",
        "BIO_reset",
        "BIO_s_file",
        "BIO_s_mem",
        "BIO_s_socket",
        "BIO_set_data",
        "BIO_set_init",
        "BIO_set_mem_eof_return",
        "BIO_set_retry_read",
        "BIO_set_retry_write",
        "BIO_set_shutdown",
        "BIO_should_read",
        "BIO_should_retry",
        "BIO_should_write",
        "BIO_shutdown_wr",
        "BIO_snprintf",
        "BIO_up_ref",
        "BIO_vfree",
        "BIO_wpending",
        "BIO_write",
        "BN_add_word",
        "BN_bin2bn",
        "BN_bn2dec",
        "BN_bn2hex",
        "BN_cmp_word",
        "BN_dup",
        "BN_free",
        "BN_hex2bn",
        "BN_new",
        "BN_num_bits",
        "BN_set_word",
        "BN_ucmp",
        "c2i_ASN1_INTEGER",
        "CRYPTO_BUFFER_free",
        "CRYPTO_BUFFER_new",
        "CRYPTO_memcmp",
        "d2i_GENERAL_NAME",
        "d2i_PKCS12_bio",
        "d2i_SSL_SESSION",
        "d2i_X509",
        "DTLS_method",
        "EC_GROUP_get_curve_name",
        "EC_GROUP_get_degree",
        "EC_GROUP_get0_order",
        "EC_KEY_check_fips",
        "EC_KEY_free",
        "EC_KEY_get0_group",
        "EC_KEY_get0_private_key",
        "EC_KEY_new_by_curve_name",
        "EC_KEY_parse_private_key",
        "EC_KEY_set_private_key",
        "EC_KEY_set_public_key_affine_coordinates",
        "EC_KEY_set_public_key",
        "EC_POINT_free",
        "EC_POINT_mul",
        "EC_POINT_new",
        "ECDSA_do_verify",
        "ECDSA_SIG_free",
        "ECDSA_SIG_get0",
        "ECDSA_SIG_new",
        "ECDSA_SIG_set0",
        "ECDSA_sign",
        "ECDSA_size",
        "ECDSA_verify",
        "ED25519_verify",
        "ERR_clear_error",
        "ERR_print_errors_fp",
        "ERR_print_errors",
        "ERR_put_error",
        "EVP_aes_128_gcm",
        "EVP_aes_256_cbc",
        "EVP_aes_256_gcm",
        "EVP_CIPHER_block_size",
        "EVP_CIPHER_CTX_ctrl",
        "EVP_CIPHER_CTX_free",
        "EVP_CIPHER_CTX_new",
        "EVP_CIPHER_iv_length",
        "EVP_CIPHER_key_length",
        "EVP_DecodeBase64",
        "EVP_DecodedLength",
        "EVP_DecryptFinal_ex",
        "EVP_DecryptInit_ex",
        "EVP_DecryptUpdate",
        "EVP_Digest",
        "EVP_DigestFinal_ex",
        "EVP_DigestFinal",
        "EVP_DigestInit_ex",
        "EVP_DigestInit",
        "EVP_DigestSign",
        "EVP_DigestSignFinal",
        "EVP_DigestSignInit",
        "EVP_DigestSignUpdate",
        "EVP_DigestUpdate",
        "EVP_DigestVerify",
        "EVP_DigestVerifyFinal",
        "EVP_DigestVerifyInit",
        "EVP_DigestVerifyUpdate",
        "EVP_EncryptFinal_ex",
        "EVP_EncryptInit_ex",
        "EVP_EncryptUpdate",
        "EVP_get_digestbyname",
        "EVP_MD_CTX_copy_ex",
        "EVP_MD_CTX_create",
        "EVP_MD_CTX_destroy",
        "EVP_MD_CTX_free",
        "EVP_MD_CTX_init",
        "EVP_MD_CTX_move",
        "EVP_MD_CTX_new",
        "EVP_MD_nid",
        "EVP_MD_size",
        "EVP_MD_type",
        "EVP_md4",
        "EVP_md5_sha1",
        "EVP_md5",
        "EVP_parse_private_key",
        "EVP_parse_public_key",
        "EVP_PKEY_assign_EC_KEY",
        "EVP_PKEY_assign_RSA",
        "EVP_PKEY_bits",
        "EVP_PKEY_cmp",
        "EVP_PKEY_CTX_set_rsa_mgf1_md",
        "EVP_PKEY_CTX_set_rsa_padding",
        "EVP_PKEY_free",
        "EVP_PKEY_get_raw_public_key",
        "EVP_PKEY_get0_EC_KEY",
        "EVP_PKEY_get0_RSA",
        "EVP_PKEY_get1_EC_KEY",
        "EVP_PKEY_get1_RSA",
        "EVP_PKEY_id",
        "EVP_PKEY_new",
        "EVP_PKEY_set1_RSA",
        "EVP_PKEY_size",
        "EVP_PKEY_up_ref",
        "EVP_sha1",
        "EVP_sha224",
        "EVP_sha256",
        "EVP_sha384",
        "EVP_sha512",
        "EVP_SignFinal",
        "EVP_SignInit_ex",
        "EVP_SignUpdate",
        "FIPS_mode",
        "GENERAL_NAME_free",
        "GENERAL_NAME_new",
        "GENERAL_NAME_set0_value",
        "GENERAL_NAME_set0_othername",
        "GENERAL_NAMES_free",
        "GENERAL_NAMES_new",
        "GENERAL_SUBTREE_free",
        "GENERAL_SUBTREE_new",
        "HMAC_CTX_free",
        "HMAC_CTX_new",
        "HMAC_Final",
        "HMAC_Init_ex",
        "HMAC_Update",
        "HMAC",
        "i2d_ASN1_OCTET_STRING",
        "i2d_SSL_SESSION",
        "i2d_X509_NAME",
        "i2d_X509_PUBKEY",
        "i2d_X509",
        "MD5",
        "NAME_CONSTRAINTS_free",
        "NAME_CONSTRAINTS_new",
        "OBJ_cmp",
        "OBJ_obj2nid",
        "OBJ_obj2txt",
        "OBJ_txt2obj",
        "OPENSSL_free",
        "OPENSSL_init_ssl",
        "OPENSSL_malloc",
        "OPENSSL_memdup",
        "OPENSSL_realloc",
        "OPENSSL_sk_free",
        "OPENSSL_sk_new_null",
        "OPENSSL_sk_num",
        "OPENSSL_sk_pop",
        "OPENSSL_sk_push",
        "OPENSSL_sk_value",
        "PEM_bytes_read_bio",
        "PEM_read_bio_PrivateKey",
        "PEM_read_bio_PUBKEY",
        "PEM_read_bio_RSAPrivateKey",
        "PEM_read_bio_X509_AUX",
        "PEM_read_bio_X509_CRL",
        "PEM_read_bio_X509",
        "PEM_write_bio_X509",
        "PEM_X509_INFO_read_bio",
        "PKCS12_free",
        "PKCS12_get_key_and_certs",
        "PKCS12_parse",
        "PKCS12_verify_mac",
        "RAND_bytes",
        "RAND_enable_fork_unsafe_buffering",
        "RSA_bits",
        "RSA_check_fips",
        "RSA_check_key",
        "RSA_decrypt",
        "RSA_encrypt",
        "RSA_free",
        "RSA_generate_key_ex",
        "RSA_get0_crt_params",
        "RSA_get0_d",
        "RSA_get0_dmp1",
        "RSA_get0_dmq1",
        "RSA_get0_e",
        "RSA_get0_factors",
        "RSA_get0_iqmp",
        "RSA_get0_key",
        "RSA_get0_n",
        "RSA_get0_p",
        "RSA_get0_q",
        "RSA_new",
        "RSA_private_key_from_bytes",
        "RSA_public_key_from_bytes",
        "RSA_set0_crt_params",
        "RSA_set0_factors",
        "RSA_set0_key",
        "RSA_sign_pss_mgf1",
        "RSA_sign",
        "RSA_size",
        "RSA_verify",
        "SHA1",
        "SHA224",
        "SHA256_Final",
        "SHA256_Init",
        "SHA256_Update",
        "SHA256",
        "SHA384",
        "SHA512",
        "SSL_accept",
        "SSL_add_file_cert_subjects_to_stack",
        "SSL_alert_desc_string_long",
        "SSL_CIPHER_get_auth_nid",
        "SSL_CIPHER_get_cipher_nid",
        "SSL_CIPHER_get_digest_nid",
        "SSL_CIPHER_get_handshake_digest",
        "SSL_CIPHER_get_id",
        "SSL_CIPHER_get_kx_nid",
        "SSL_CIPHER_get_min_version",
        "SSL_CIPHER_get_name",
        "SSL_CIPHER_get_prf_nid",
        "SSL_CIPHER_get_version",
        "SSL_CIPHER_standard_name",
        "SSL_clear",
        "SSL_connect",
        "SSL_CTX_add_extra_chain_cert",
        "SSL_CTX_check_private_key",
        "SSL_CTX_free",
        "SSL_CTX_get_cert_store",
        "SSL_CTX_get_ciphers",
        "SSL_CTX_get_client_CA_list",
        "SSL_CTX_get_ex_data",
        "SSL_CTX_get_ex_new_index",
        "SSL_CTX_get_max_proto_version",
        "SSL_CTX_get_min_proto_version",
        "SSL_CTX_get_options",
        "SSL_CTX_get_session_cache_mode",
        "SSL_CTX_get_verify_mode",
        "SSL_CTX_get0_certificate",
        "SSL_CTX_get0_param",
        "SSL_CTX_load_verify_locations",
        "SSL_CTX_new",
        "SSL_CTX_sess_set_new_cb",
        "SSL_CTX_set_alpn_protos",
        "SSL_CTX_set_alpn_select_cb",
        "SSL_CTX_set_cert_cb",
        "SSL_CTX_set_cert_store",
        "SSL_CTX_set_cert_verify_callback",
        "SSL_CTX_set_cipher_list",
        "SSL_CTX_set_client_CA_list",
        "SSL_CTX_set_compliance_policy",
        "SSL_CTX_set_custom_verify",
        "SSL_CTX_set_ex_data",
        "SSL_CTX_set_keylog_callback",
        "SSL_CTX_set_max_proto_version",
        "SSL_CTX_set_min_proto_version",
        "SSL_CTX_set_next_proto_select_cb",
        "SSL_CTX_set_next_protos_advertised_cb",
        "SSL_CTX_set_options",
        "SSL_CTX_set_private_key_method",
        "SSL_CTX_set_select_certificate_cb",
        "SSL_CTX_set_session_cache_mode",
        "SSL_CTX_set_session_id_context",
        "SSL_CTX_set_strict_cipher_list",
        "SSL_CTX_set_timeout",
        "SSL_CTX_set_tlsext_servername_arg",
        "SSL_CTX_set_tlsext_servername_callback",
        "SSL_CTX_set_tlsext_status_cb",
        "SSL_CTX_set_tlsext_ticket_key_cb",
        "SSL_CTX_set_tlsext_ticket_keys",
        "SSL_CTX_set_tmp_ecdh",
        "SSL_CTX_set_verify_algorithm_prefs",
        "SSL_CTX_set_verify_depth",
        "SSL_CTX_set_verify",
        "SSL_CTX_set1_curves_list",
        "SSL_CTX_set1_sigalgs_list",
        "SSL_CTX_use_certificate_chain_file",
        "SSL_CTX_use_certificate_file",
        "SSL_CTX_use_certificate",
        "SSL_CTX_use_PrivateKey_file",
        "SSL_CTX_use_PrivateKey",
        "SSL_do_handshake",
        "SSL_early_callback_ctx_extension_get",
        "SSL_enable_ocsp_stapling",
        "SSL_error_description",
        "SSL_free",
        "SSL_get_all_cipher_names",
        "SSL_get_all_signature_algorithm_names",
        "SSL_get_all_version_names",
        "SSL_get_certificate",
        "SSL_get_cipher_by_value",
        "SSL_get_ciphers",
        "SSL_get_client_CA_list",
        "SSL_get_current_cipher",
        "SSL_get_curve_id",
        "SSL_get_error",
        "SSL_get_ex_data_X509_STORE_CTX_idx",
        "SSL_get_ex_data",
        "SSL_get_ex_new_index",
        "SSL_get_peer_cert_chain",
        "SSL_get_peer_certificate",
        "SSL_get_peer_full_cert_chain",
        "SSL_get_peer_signature_algorithm",
        "SSL_get_quiet_shutdown",
        "SSL_get_rbio",
        "SSL_get_servername",
        "SSL_get_session",
        "SSL_get_signature_algorithm_digest",
        "SSL_get_signature_algorithm_key_type",
        "SSL_get_signature_algorithm_name",
        "SSL_get_SSL_CTX",
        "SSL_get_verify_result",
        "SSL_get_version",
        "SSL_get_wbio",
        "SSL_get0_alpn_selected",
        "SSL_get0_next_proto_negotiated",
        "SSL_get0_ocsp_response",
        "SSL_get0_peer_certificates",
        "SSL_get0_peer_verify_algorithms",
        "SSL_get1_session",
        "SSL_is_init_finished",
        "SSL_is_server",
        "SSL_is_signature_algorithm_rsa_pss",
        "SSL_new",
        "SSL_read",
        "SSL_select_next_proto",
        "SSL_send_fatal_alert",
        "SSL_SESSION_free",
        "SSL_SESSION_from_bytes",
        "SSL_SESSION_get_id",
        "SSL_SESSION_get_ticket_lifetime_hint",
        "SSL_SESSION_get_version",
        "SSL_SESSION_is_resumable",
        "SSL_SESSION_new",
        "SSL_session_reused",
        "SSL_SESSION_set_protocol_version",
        "SSL_SESSION_should_be_single_use",
        "SSL_SESSION_to_bytes",
        "SSL_SESSION_up_ref",
        "SSL_set_accept_state",
        "SSL_set_alpn_protos",
        "SSL_set_bio",
        "SSL_set_cert_cb",
        "SSL_set_chain_and_key",
        "SSL_set_cipher_list",
        "SSL_set_client_CA_list",
        "SSL_set_connect_state",
        "SSL_set_ex_data",
        "SSL_set_fd",
        "SSL_set_info_callback",
        "SSL_set_ocsp_response",
        "SSL_set_quiet_shutdown",
        "SSL_set_renegotiate_mode",
        "SSL_set_session_id_context",
        "SSL_set_session",
        "SSL_set_SSL_CTX",
        "SSL_set_tlsext_host_name",
        "SSL_set_verify",
        "SSL_set0_CA_names",
        "SSL_set0_rbio",
        "SSL_set0_wbio",
        "SSL_set1_curves_list",
        "SSL_shutdown",
        "SSL_state_string_long",
        "SSL_state_string",
        "SSL_version",
        "SSL_write",
        "TLS_client_method",
        "TLS_method",
        "TLS_server_method",
        "TLS_VERSION_to_string",
        "TLS_with_buffers_method",
        "X509_add1_ext_i2d",
        "X509_alias_get0",
        "X509_cmp",
        "X509_CRL_cmp",
        "X509_CRL_dup",
        "X509_CRL_free",
        "X509_CRL_get_ext_by_NID",
        "X509_CRL_get_ext",
        "X509_CRL_get_issuer",
        "X509_CRL_get0_by_cert",
        "X509_CRL_up_ref",
        "X509_CRL_verify",
        "X509_digest",
        "X509_EXTENSION_get_data",
        "X509_EXTENSION_get_object",
        "X509_free",
        "X509_get_ext_by_NID",
        "X509_get_ext_by_OBJ",
        "X509_get_ext_count",
        "X509_get_ext_d2i",
        "X509_get_ext",
        "X509_get_extension_flags",
        "X509_get_issuer_name",
        "X509_get_key_usage",
        "X509_get_pathlen",
        "X509_get_pubkey",
        "X509_get_serialNumber",
        "X509_get_subject_name",
        "X509_get_X509_PUBKEY",
        "X509_get0_notAfter",
        "X509_get0_notBefore",
        "X509_getm_notAfter",
        "X509_getm_notBefore",
        "X509_INFO_free",
        "X509_NAME_add_entry_by_txt",
        "X509_NAME_cmp",
        "X509_NAME_digest",
        "X509_NAME_dup",
        "X509_NAME_entry_count",
        "X509_NAME_ENTRY_get_data",
        "X509_NAME_ENTRY_get_object",
        "X509_NAME_ENTRY_set",
        "X509_NAME_free",
        "X509_NAME_get_entry",
        "X509_NAME_get_index_by_NID",
        "X509_NAME_new",
        "X509_NAME_oneline",
        "X509_NAME_print_ex",
        "X509_new",
        "X509_PUBKEY_get",
        "X509_PUBKEY_get0_param",
        "X509_set_issuer_name",
        "X509_set_pubkey",
        "X509_set_serialNumber",
        "X509_set_subject_name",
        "X509_set_version",
        "X509_sign",
        "X509_STORE_add_cert",
        "X509_STORE_add_crl",
        "X509_STORE_CTX_free",
        "X509_STORE_CTX_get_current_cert",
        "X509_STORE_CTX_get_error_depth",
        "X509_STORE_CTX_get_error",
        "X509_STORE_CTX_get_ex_data",
        "X509_STORE_CTX_get0_cert",
        "X509_STORE_CTX_get0_chain",
        "X509_STORE_CTX_get0_param",
        "X509_STORE_CTX_get0_untrusted",
        "X509_STORE_CTX_init",
        "X509_STORE_CTX_new",
        "X509_STORE_CTX_set_default",
        "X509_STORE_CTX_set_error",
        "X509_STORE_CTX_set_flags",
        "X509_STORE_CTX_set_verify_cb",
        "X509_STORE_CTX_set0_crls",
        "X509_STORE_CTX_set0_trusted_stack",
        "X509_STORE_free",
        "X509_STORE_get0_param",
        "X509_STORE_load_locations",
        "X509_STORE_new",
        "X509_STORE_set_flags",
        "X509_STORE_set_verify_cb",
        "X509_STORE_up_ref",
        "X509_up_ref",
        "X509_verify_cert_error_string",
        "X509_verify_cert",
        "X509_VERIFY_PARAM_clear_flags",
        "X509_VERIFY_PARAM_get_flags",
        "X509_VERIFY_PARAM_set_depth",
        "X509_VERIFY_PARAM_set_flags",
        "X509_VERIFY_PARAM_set_time_posix",
        "X509_VERIFY_PARAM_set1",
        "X509_verify",
    ],
)

# Full bssl-compat library
cc_library(
    name = "bssl-compat",
    srcs = [
        ":mapping_function_sources",
        ":patched_bssl_headers",
        ":patched_bssl_sources",
        ":prefixed_ossl_source",
    ] + [
        "include/ext/openssl/ssl.h",
        "source/CRYPTO_BUFFER.h",
        "source/SSL_CTX_set_select_certificate_cb.h",
        "source/SSL_get_curve_name.cc",
        "source/err.cc",
        "source/ext_SSL_get_all_async_fds.c",
        "source/iana_2_ossl_names.cc",
        "source/iana_2_ossl_names.h",
        "source/internal.h",
        "source/log.c",
        "source/log.h",
        "source/ossl_dlutil.c",
        "source/ossl_dlutil.h",
        "source/override.cc",
        "source/override.h",
        "source/stack.c",
    ],

    # Add the OpenSSL shared libraries as a *data* dependency, so they get
    # propagated to dependant targets, and made available in their runfiles
    # directory when they run, so libbssl-compat.a can dlopen() them.
    data = ["@openssl//:libs"],
    includes = [
        "include",
        "source",
    ],
    linkopts = ["-ldl"],
    linkstatic = True,
    visibility = ["//visibility:public"],
)

# Aliases for compatibility
alias(
    name = "ssl",
    actual = ":bssl-compat",
    visibility = ["//visibility:public"],
)

alias(
    name = "crypto",
    actual = ":bssl-compat",
    visibility = ["//visibility:public"],
)
