# AWS Request Signing Extensions Architecture

## Credential Providers

Credential Providers (`Envoy::Extensions::Common::Aws::CredentialsProvider`) are implemented in a similar way to the AWS SDK. Each provider specialises in retrieving credentials from a particular source.
The simplest providers are those which retrieve from static sources, such as the `ConfigCredentialsProvider` or `EnvironmentCredentialsProvider`.
Each credentials provider inherits from `CredentialsProvider`.

## Credential Provider Chain

A credential provider chain (`Envoy::Extensions::Common::Aws::CredentialsProviderChain`) is a simple ordered list of credential providers. Convenience methods
for creating standard credential providers are provided, the most common being the default credential provider chain
(`Extensions::Common::Aws::CommonCredentialsProviderChain::defaultCredentialsProviderChain`)
By creating the `defaultCredentialsProviderChain` you receive a list of credential providers in the following order, which align to the precedence in which credentials will be retrieved. Once an earlier credentials provider returns credentials via `getCredentials()`, no further providers will be checked.

- `EnvironmentCredentialsProvider`
- `CredentialsFileCredentialsProvider`
- `WebIdentityCredentialsProvider`
- `ContainerCredentialsProvider`
- `InstanceProfileCredentialsProvider`

## Metadata Credential Providers

Metadata credential providers (`Envoy::Extensions::Common::Aws::MetadataCredentialsProviderBase`) are credential providers that use asynchronous HTTP requests to retrieve credentials. To do this, they require an upstream cluster to be created by the AWS Cluster Manager.
Metadata credential providers may be instantiated as singletons. For example, the `InstanceProfileCredentialsProvider` is instantiated as a singleton, as there is only a single instance of the instance metadata service ([IMDS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html)) on a host. By instantiating the provider as a singleton, it ensures that multiple configured credential provider chains (such as when per route configuration is used) do not result in multiple credential retrieval cycles against the IMDS. The `ContainerCredentialProvider` is also instantiated as a singleton for this reason.

## AWS Cluster Manager

More than one metadata credential provider can use the same cluster where the destination is identical. To remove redundancy in the case of multiple configured extensions, the AWS Cluster Manager provides a cluster creation and cluster online subscription/notification service.
When Metadata Credential Providers are instantiated, they will request cluster creation via the AWS Cluster Manager `addManagedCluster` method. They will also subscribe to notifications using the `addManagedClusterUpdateCallback`s method.
When AWS Cluster Manager receives a cluster creation request, it will create it if no other cluster exists, otherwise it will reuse an existing cluster to the same destination. When the cluster comes online, the metadata credentials provider will be notified that it is safe to begin its credential refresh cycle.
The AWS Cluster Manager is instantiated as a pinned singleton, meaning once instantiated it will survive for the life of the server. In this way, replacing instances of the `aws_request_signing` or `aws_lambda` extension will not result in recreation (and associated delay) of new cluster creation.

## Signing

The AWS common components support signing with both [AWS SigV4 and AWS SigV4A](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_sigv.html)
They use the signing test corpus from [aws-c-auth](https://github.com/awslabs/aws-c-auth/tree/main/tests/aws-signing-test-suite) to test signing behaviour against that generated by the AWS SDKs.
The signing components support async credential retrieval by metadata credential providers, to ensure uninterrupted operation while credential retrieval is in flight.

## Asynchronous credential retrieval

The aws_lambda and aws_request_signing extensions support handling of async credential retrieval, meaning upstream requests will be paused while waiting on credentials to be returned.
To support this, a subscription/notification system is used to signal completion of credential retrieval to a waiting credential provider chain.
A credential provider chain can call `subscribeToCredentialUpdates` on a metadata credentials provider during initialization of the provider. When the provider has retrieved (or failed to retrieve) credentials, it will notify the credentials provider chain with the `onCredentialUpdate` callback.
When signing a request, the signer will call `addCallbackIfCredentialsPending` on its credential chain, to store a callback if credentials are not available at this time. This will register a callback with the credentials provider chain, which will be called upon the credentials provider chain being notified via `onCredentialUpdate`.
Each extension using the signing async capability will use `addCallbackIfCredentialsPending` to pause execution while credentials arrive.
